version: '3.5'
services:
  orion:
    build: ./orion/
    restart: unless-stopped
    ports:
      - "127.0.0.1:5500:5000"
      - "127.0.0.1:5501:8080"
    depends_on:
      - mysql
      - redis
  firefox:
    build: ./ff-sync/
    network_mode: host
    restart: unless-stopped
    env_file:
      - '.env.syncserver'
    environment:
      - SYNCSERVER_SQLURI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:4101/ffsync
    depends_on:
      - database
  redis:
    image: redis:4.0.10
    ports:
      - 6379:6379
    volumes:
      - .docker/data/redis:/data
  calendar:
    image: nextcloud:latest
    ports:
      - 4111:80
    env_file:
      - '.env.nextcloud'
    volumes:
      - .docker/data/nextcloud:/var/www/html
      - /mnt/homes/nextcloud:/var/www/html/data/
  mqtt:
    restart: unless-stopped
    image: eclipse-mosquitto:latest
    ports:
      - 0.0.0.0:4105:1883
    volumes:
      - .docker/data/mosquitto:/mosquitto/data
      - .docker/log/mosquitto.log:/mosquitto/log/mosquitto.log
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
  influxdb:
    restart: unless-stopped
    image: influxdb:latest
    ports:
      - "0.0.0.0:8086:8086"
    volumes:
      - .docker/data/influxdb:/var/lib/influxdb
    env_file:
      - '.env.influxdb'
  database:
    image: postgres:9.6.10-alpine
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    ports:
      - 0.0.0.0:4101:5432
    environment:
      PGDATA: /data
    env_file:
      - '.env.postgresql'
    volumes:
      - ./postgresql/:/docker-entrypoint-initdb.d/
      - .docker/data/postgresql:/data
  mysql:
    image: mysql:latest
    env_file: 
      - '.env.mysql'
    volumes:
      - .docker/data/mysql:/var/lib/mysql
  grafana:
    image: grafana/grafana:5.4.2
    restart: unless-stopped
    user: "472"
    env_file:
      - '.env.grafana'
      - '.env.influxdb'
      - '.env.local'
    environment:
      GF_SERVER_DOMAIN: "${HOME_ASSISTANT_DOMAIN}"
      GF_SERVER_ROOT_URL: "https://${HOME_ASSISTANT_DOMAIN}/grafana/"
    ports:
      - "127.0.0.1:4100:3000"
    volumes:
      - .docker/data/grafana:/var/lib/grafana
    depends_on:
      - influxdb
  glances:
    restart: unless-stopped
    image: nicolargo/glances
    environment:
      - GLANCES_OPT=-w
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./glances/:/glances/conf/
    ports:
      - 4108:61208
  vacuum:
    build: ./vacuum/
    volumes:
      - .docker/data/vacuum:/app/public
    ports:
      - 10005:3000
  esphome:
    image: esphome/esphome:latest
    volumes:
      - .docker/data/esphome:/config
      - /etc/localtime:/etc/localtime:ro
    network_mode: host
  notes:
    build: ./notes/
    ports:
      - 12005:3000
    links:
      - mysql
    env_file:
      - '.env.notes'
      - '.env.mysql'
    
